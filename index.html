<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notion Habit Heat Map</title>
  <style>
    :root { --bg:#0b0d10; --panel:#13161a; --muted:#9aa4af; --fg:#e6ebf0; --grid:#1f242b; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font:14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    .title { font-weight:600; letter-spacing:0.2px; }
    .hint { color:var(--muted); font-size:12px; }
    .panel { background:var(--panel); border:1px solid #222831; border-radius:14px; padding:14px; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    button, input[type="number"], input[type="text"], select, input[type="color"]{ background:#11151b; color:var(--fg); border:1px solid #2a313b; border-radius:10px; padding:8px 10px; }
    button:hover{ border-color:#3a4452; }
    .heat { display:flex; gap:6px; overflow:auto; padding:8px 2px; }
    .week { display:flex; flex-direction:column; gap:6px; }
    .cell { width:14px; height:14px; border-radius:3px; background:var(--grid); position:relative; cursor:pointer; outline:1px solid #0f1318; }
    .tooltip { position:fixed; pointer-events:none; background:#0e1116; border:1px solid #272f3a; padding:6px 9px; border-radius:8px; font-size:12px; color:var(--fg); z-index:50; transform:translate(-50%, -120%); white-space:nowrap; }
    .legend { display:flex; align-items:center; gap:6px; color:var(--muted); font-size:12px; }
    .legend .sw { width:12px; height:12px; border-radius:3px; outline:1px solid #0f1318; background:#1b2430; }
    .stats { display:flex; gap:16px; margin-top:10px; color:var(--muted); font-size:13px; flex-wrap:wrap; }
    .pop, .modal { position:fixed; z-index:100; background:#0e1116; border:1px solid #2a313b; border-radius:12px; padding:10px; display:none; min-width: 240px; }
    .modal { max-width: 360px; }
    .modal header { display:flex; justify-content:space-between; align-items:center; margin:0 0 8px 0; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title" id="habitTitle">Habit</div>
      <div class="hint" id="dateRange">–</div>
    </div>
    <div class="row">
      <select id="habitSelect"></select>
      <button id="btnNewHabit">+ New Habit</button>
      <select id="timeframe"></select>
      <input id="qty" type="number" min="0" step="1" placeholder="quantity" style="width:120px" />
      <button id="btnToday">Log Today</button>
      <button id="btnUndo" disabled>Undo</button>
      <button id="btnReload" title="Sync from Notion">↻ Sync</button>
    </div>
  </header>

  <div class="panel">
    <div class="heat" id="heat"></div>
    <div class="legend" id="legend" style="margin-top:10px">
      <span>Less</span>
      <span class="sw" data-lvl="0"></span>
      <span class="sw" data-lvl="1"></span>
      <span class="sw" data-lvl="2"></span>
      <span class="sw" data-lvl="3"></span>
      <span class="sw" data-lvl="4"></span>
      <span>More</span>
    </div>
    <div class="stats" id="stats"></div>
  </div>

  <div class="tooltip" id="tip" style="display:none"></div>

  <!-- quantity popover on cell click -->
  <div class="pop" id="pop">
    <div class="row" style="margin-bottom:8px">
      <div id="popDate" class="hint"></div>
      <strong id="popVal">0</strong>
    </div>
    <div class="row">
      <button id="minus">−</button>
      <input id="num" type="number" min="0" step="1" value="0" style="width:100px" />
      <button id="plus">+</button>
      <button id="save">Save</button>
      <button id="clear">Clear</button>
    </div>
  </div>

  <!-- New Habit modal -->
  <div class="modal" id="habitModal">
    <header>
      <strong>Create Habit</strong>
      <button id="closeHabit">✕</button>
    </header>
    <div class="row" style="flex-direction:column; align-items:stretch; gap:8px;">
      <input id="hName" type="text" placeholder="Habit name (e.g., Deep Work)" />
      <input id="hUnit" type="text" placeholder="Unit (e.g., minutes)" />
      <div class="row">
        <label for="hColor" class="hint">Color</label>
        <input id="hColor" type="color" value="#35c27a" />
      </div>
      <button id="hCreate">Create</button>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const CONFIG = {
    db: qs.get('db') || '',              // Logs DB
    habitsDb: qs.get('habitsDb') || '',  // Habit Settings DB (else server uses env)
    writeKey: qs.get('writeKey') || null,
    useTitleForHabit: qs.get('useTitleForHabit') === 'true',
    apiBase: qs.get('apiBase') || '',
    defaultHabit: qs.get('habit') || ''
  };

  const $heat = id('heat');
  const $tip = id('tip');
  const $pop = id('pop');
  const $habitTitle = id('habitTitle');
  const $dateRange = id('dateRange');
  const $btnToday = id('btnToday');
  const $qty = id('qty');
  const $btnUndo = id('btnUndo');
  const $habitSelect = id('habitSelect');
  const $timeframe = id('timeframe');

  let GRID = [];           // [{date, value}]
  let SCALE = [0,1,2,3,4];
  let META = { habit:'', unit:'', colorHex:'#35c27a' };
  let RANGE = { start:null, end:null, spanDays:365 };
  let lastAction = null;   // { date, prevValue, newValue }

  init();

  async function init(){
    await loadHabits();
    buildTimeframeOptions();
    await loadAndRender();
    wire();
  }

  function api(path){ const base = CONFIG.apiBase || ''; return base + path; }

  async function loadHabits(){
    const r = await fetch(api('/api/habits'));
    const j = await r.json();
    const habits = (j.habits || []).sort((a,b)=>a.name.localeCompare(b.name));
    $habitSelect.innerHTML = habits.map(h=>`<option value="${esc(h.name)}" data-unit="${esc(h.unit)}" data-color="${esc(h.colorHex)}">${esc(h.name)}</option>`).join('');
    if (CONFIG.defaultHabit) $habitSelect.value = CONFIG.defaultHabit;
    if (!$habitSelect.value && habits[0]) $habitSelect.value = habits[0].name;
  }

  function buildTimeframeOptions(){
    const now = new Date();
    const curY = now.getFullYear();
    const years = [curY, curY-1, curY-2];
    $timeframe.innerHTML = `<option value="last365">Last 365 days</option>` + years.map(y=>`<option value="year:${y}">Year ${y}</option>`).join('');
    $timeframe.value = 'last365';
  }

  async function load(){
    const habit = $habitSelect.value || '';
    const tf = $timeframe.value;
    let params = new URLSearchParams();
    params.set('db', CONFIG.db);
    params.set('habit', habit);
    if (CONFIG.habitsDb) params.set('habitsDb', CONFIG.habitsDb);

    if (tf === 'last365') {
      params.set('spanDays', '365');
    } else if (tf.startsWith('year:')) {
      const y = Number(tf.split(':')[1]);
      const start = `${y}-01-01`; const end = `${y}-12-31`;
      const span = (new Date(`${y}-12-31T00:00:00`) - new Date(`${y}-01-01T00:00:00`)) / 86400000 + 1;
      params.set('start', start); params.set('spanDays', String(span));
    }

    const r = await fetch(api('/api/heatmap') + '?' + params.toString());
    const j = await r.json();
    GRID = j.days || [];
    RANGE = { start:j.start, end:j.end, spanDays:j.spanDays };
    META = j.meta || META;
    $habitTitle.textContent = META.habit || habit || 'Habit';
    $qty.placeholder = META.unit ? META.unit : 'units';
    $dateRange.textContent = `${RANGE.start} → ${RANGE.end} · ${RANGE.spanDays} days`;
    buildScale();
  }

  async function loadAndRender(){ await load(); render(); renderStats(); }

  function buildScale(){
    const vals = GRID.map(d => d.value).filter(v => v>0).sort((a,b)=>a-b);
    if (vals.length < 5) { SCALE = [0,1,2,3,4]; return; }
    const q = p => vals[Math.floor((vals.length-1)*p)];
    SCALE = [0, q(0.2), q(0.4), q(0.6), q(0.8)];
  }

  function level(v){ if (v<=0) return 0; let lvl=1; if (v> SCALE[4]) lvl=4; else if (v> SCALE[3]) lvl=3; else if (v> SCALE[2]) lvl=2; else lvl=1; return lvl; }

  function render(){
    $heat.innerHTML = '';
    const weeks = chunkWeeks(GRID);
    const palette = buildPalette(META.colorHex);
    for (const wk of weeks) {
      const col = el('div','week');
      for (const d of wk) {
        const c = el('div','cell');
        c.dataset.date = d.date; c.dataset.v = String(d.value||0);
        const lvl = level(d.value||0); c.dataset.level = String(lvl);
        c.style.background = lvl===0 ? '#1b2430' : palette[lvl];
        c.addEventListener('mouseenter', e => showTip(e, d));
        c.addEventListener('mouseleave', hideTip);
        c.addEventListener('click', e => openPop(e, d));
        col.appendChild(c);
      }
      $heat.appendChild(col);
    }
    // legend
    const sw = document.querySelectorAll('.legend .sw');
    const pal = buildPalette(META.colorHex);
    sw[0].style.background = '#1b2430';
    sw[1].style.background = pal[1];
    sw[2].style.background = pal[2];
    sw[3].style.background = pal[3];
    sw[4].style.background = pal[4];
  }

  function renderStats(){
    const sum = GRID.reduce((a,b)=>a+(Number(b.value)||0),0);
    const active = GRID.filter(d => (Number(d.value)||0) > 0);
    const avg = active.length ? (sum / active.length) : 0;
    const streak = calcStreak(GRID);
    const unit = META.unit ? ` ${META.unit}` : '';
    id('stats').innerHTML = `
      <div><strong>Total:</strong> ${fmt(sum)}${unit}</div>
      <div><strong>Average (active days):</strong> ${fmt(avg)}${unit}</div>
      <div><strong>Streak:</strong> ${streak} day${streak===1?'':'s'}</div>
    `;
  }

  function calcStreak(arr){
    let s=0; for (let i=arr.length-1;i>=0;i--){ const v=Number(arr[i].value)||0; if (v>0) s++; else break; } return s; }

  function chunkWeeks(days){ const weeks=[]; let buf=[]; for (let i=0;i<days.length;i++){ buf.push(days[i]); if (buf.length===7){ weeks.push(buf); buf=[]; } } if (buf.length) weeks.push(buf); return weeks; }

  function showTip(evt, d){ $tip.style.display='block'; $tip.textContent = `${d.date} · ${d.value||0}${META.unit?(' '+META.unit):''}`; position($tip, evt.clientX, evt.clientY); }
  function hideTip(){ $tip.style.display='none'; }
  function position(node,x,y){ node.style.left=x+'px'; node.style.top=y+'px'; }

  function openPop(evt, d){
    id('popDate').textContent = d.date;
    id('num').value = String(d.value||0);
    id('popVal').textContent = String(d.value||0);
    $pop.style.display='block'; position($pop, evt.clientX+10, evt.clientY+10);
    const onDocClick = (e)=>{ if(!($pop.contains(e.target) || e.target.classList.contains('cell'))) closePop(); };
    setTimeout(()=>document.addEventListener('click', onDocClick, { once:true }), 0);
    id('minus').onclick = ()=>{ step(-1); };
    id('plus').onclick = ()=>{ step(+1); };
    id('num').oninput = ()=>{ syncVal(); };
    id('save').onclick = ()=> saveWithUndo(d.date, intish(id('num').value)||0);
    id('clear').onclick = ()=> saveWithUndo(d.date, 0);
    function step(n){ const v = Math.max(0, (intish(id('num').value)||0)+n); id('num').value=String(v); syncVal(); }
    function syncVal(){ id('popVal').textContent = String(intish(id('num').value)||0); }
    function closePop(){ $pop.style.display='none'; }
  }

  async function saveWithUndo(date, newValue){
    const cur = GRID.find(x => x.date===date) || { value:0 };
    lastAction = { date, prevValue: Number(cur.value||0), newValue: Number(newValue||0) };
    $btnUndo.disabled = false;
    await save(date, newValue);
  }

  async function undo(){
    if (!lastAction) return;
    const { date, prevValue } = lastAction; lastAction = null; $btnUndo.disabled = true;
    await save(date, prevValue);
  }

  async function save(date, value){
    const r = await fetch(api('/api/log'), {
      method: 'POST', headers: { 'Content-Type':'application/json', ...(CONFIG.writeKey?{'X-Write-Key':CONFIG.writeKey}:{}) },
      body: JSON.stringify({ db: CONFIG.db, habit: $habitSelect.value, date, value, useTitleForHabit: CONFIG.useTitleForHabit, writeKey: CONFIG.writeKey })
    });
    if (!r.ok) { alert('Save failed'); return; }
    await loadAndRender(); $pop.style.display='none';
  }

  function wire(){
    id('btnReload').onclick = async()=>{ await loadAndRender(); };
    $btnUndo.onclick = ()=> undo();
    $btnToday.onclick = async()=>{
      const qty = intish($qty.value); if (qty===null || qty<0){ alert('Enter a non-negative number'); return; }
      const today = ymd(todayLocal());
      await saveWithUndo(today, qty);
      $qty.value='';
    };
    $habitSelect.onchange = ()=> loadAndRender();
    $timeframe.onchange = ()=> loadAndRender();

    // Habit modal
    const $modal = id('habitModal');
    id('btnNewHabit').onclick = ()=>{ $modal.style.display='block'; };
    id('closeHabit').onclick = ()=>{ $modal.style.display='none'; };
    id('hCreate').onclick = async()=>{
      const name = id('hName').value.trim();
      const unit = id('hUnit').value.trim();
      const colorHex = id('hColor').value.trim();
      if (!name) { alert('Name required'); return; }
      const r = await fetch(api('/api/habits'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, unit, colorHex }) });
      if (!r.ok){ alert('Create failed'); return; }
      id('habitModal').style.display='none'; id('hName').value=''; id('hUnit').value='';
      await loadHabits(); $habitSelect.value = name; await loadAndRender();
    };
  }

  // Color helpers: build 4 shades from base hex
  function buildPalette(hex){
    const [h,s,l] = hexToHsl(hex);
    // levels 1..4 get progressively brighter
    return {
      1: hslToHex(h, s, clamp01(l*0.6)),
      2: hslToHex(h, s, clamp01(l*0.75)),
      3: hslToHex(h, s, clamp01(l*0.9)),
      4: hslToHex(h, s, clamp01(Math.min(0.98, l*1.05)))
    };
  }
  function hexToHsl(hex){
    const [r,g,b]=hexToRgb(hex).map(x=>x/255); const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h,s,l=(max+min)/2; if(max===min){ h=s=0; } else { const d=max-min; s=l>0.5? d/(2-max-min): d/(max+min); switch(max){case r: h=(g-b)/d+(g<b?6:0); break; case g: h=(b-r)/d+2; break; case b: h=(r-g)/d+4; break;} h/=6; }
    return [h,s,l];
  }
  function hslToHex(h,s,l){ const rgb = hslToRgb(h,s,l).map(x=> Math.round(x*255)); return '#'+rgb.map(x=>x.toString(16).padStart(2,'0')).join(''); }
  function hslToRgb(h,s,l){ let r,g,b; if(s===0){ r=g=b=l; } else { const hue2rgb=(p,q,t)=>{ if(t<0) t+=1; if(t>1) t-=1; if(t<1/6) return p+(q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p+(q-p)*(2/3 - t)*6; return p; }; const q=l<0.5? l*(1+s): l+s-l*s; const p=2*l-q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3);} return [r,g,b]; }
  function hexToRgb(hex){ const h=hex.replace('#',''); return [parseInt(h.slice(0,2),16), parseInt(h.slice(2,4),16), parseInt(h.slice(4,6),16)]; }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  // utils
  function id(s){ return document.getElementById(s); }
  function el(tag, cls){ const n=document.createElement(tag); if(cls) n.className=cls; return n; }
  function intish(s){ const n = Number(s); return Number.isFinite(n)?n:null; }
  function fmt(n){ return (Math.round(n*100)/100).toString(); }
  function ymd(d){ const z=n=>n<10?'0'+n:n; return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
  function todayLocal(){ const now=new Date(); return new Date(now.getFullYear(), now.getMonth(), now.getDate()); }
  function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
})();
</script>
</body>
</html>
