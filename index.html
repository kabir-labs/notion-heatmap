<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Heatmap Habits</title>
  <style>
    :root{ --bg:#f7f8fb; --card:#ffffff; --ink:#0d1421; --muted:#98a1b3; --line:#e6e9f0; --chip:#f1f4f9; --accent:#2f6feb; --ok:#2db36d; }
    .dark:root, .dark{ --bg:#0b0e14; --card:#12171f; --ink:#e7edf6; --muted:#9aa4af; --line:#1e2530; --chip:#0f1420; --accent:#7aa2ff; --ok:#42d992; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--ink); font:14px/1.3 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    .top{ display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .search{ flex:1; background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px 12px; color:var(--ink); }
    .btn{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px 12px; cursor:pointer; }
    .btn:hover{ border-color:#cbd4e1; }
    .menu{ position:relative; }
    .menu .dd{ position:absolute; right:0; top:110%; background:var(--card); border:1px solid var(--line); border-radius:12px; min-width:220px; display:none; z-index:20; }
    .menu.open .dd{ display:block; }
    .dd .item{ padding:10px 12px; cursor:pointer; border-bottom:1px solid var(--line); }
    .dd .item:last-child{ border-bottom:none; }
    .grid{ display:flex; flex-direction:column; gap:18px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; }
    .hdr{ display:flex; align-items:center; justify-content:space-between; }
    .title{ font-weight:700; letter-spacing:0.2px; font-size:22px; }
    .icons{ display:flex; gap:8px; }
    .iconbtn{ background:var(--chip); border:1px solid var(--line); border-radius:10px; padding:8px; cursor:pointer; }
    .heat{ display:flex; gap:6px; overflow:auto; padding:8px 2px; }
    .week{ display:flex; flex-direction:column; gap:6px; }
    .cell{ width:14px; height:14px; border-radius:3px; background:#e9edf4; outline:1px solid #d7dfea22; cursor:pointer; }
    .rowlbls{ color:var(--muted); font-size:12px; width:28px; margin-right:6px; }
    .monthbar{ display:flex; gap:34px; color:var(--muted); font-size:12px; margin:6px 0 2px; }
    .stats{ color:var(--muted); display:flex; gap:16px; margin-top:8px; font-size:13px; }
    .cta{ margin-top:10px; }
    .todayDone{ background:var(--chip); border:1px solid var(--line); border-radius:12px; padding:8px 10px; display:inline-flex; align-items:center; gap:8px; }
    .modal, .pop{ position:fixed; left:0; top:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; z-index:50; }
    .modal .panel, .pop .panel{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; min-width:360px; max-width:92vw; }
    .row{ display:flex; align-items:center; gap:10px; }
    .field{ background:var(--chip); border:1px solid var(--line); border-radius:10px; padding:8px 10px; width:100%; color:var(--ink); }
    .tiny{ color:var(--muted); font-size:12px; }
    .tooltip{ position:fixed; pointer-events:none; background:var(--card); border:1px solid var(--line); padding:6px 9px; border-radius:8px; font-size:12px; color:var(--ink); display:none; z-index:100; white-space:pre; }
    .k{ font-weight:600; }
  </style>
</head>
<body>
<div id="root" class="wrap">

  <div class="top">
    <input id="q" class="search" placeholder="Search habits" />
    <button class="btn" id="reorder">Reorder</button>
    <div class="menu" id="createMenu">
      <button class="btn">Create habit â–¾</button>
      <div class="dd">
        <div class="item" data-type="number"># Number</div>
        <div class="item" data-type="checkbox">â˜‘ï¸Ž Checkbox</div>
      </div>
    </div>
  </div>

  <div id="list" class="grid"></div>
</div>

<div id="tip" class="tooltip"></div>

<!-- Log popup -->
<div id="logPop" class="pop">
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div id="dot" style="width:10px;height:10px;border-radius:50%;background:#f2c14e"></div>
        <strong id="lpHabit" style="margin-left:6px"></strong>
      </div>
      <button class="btn" id="esc1">esc</button>
    </div>
    <div class="tiny" style="margin-top:10px">Date:</div>
    <div id="lpDate" style="margin:6px 0 10px 0; font-weight:600"></div>
    <div id="lpValWrap">
      <div class="tiny">Quantity:</div>
      <input id="lpVal" class="field" type="number" min="0" step="1"/>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div id="lpStreak" class="tiny" style="display:flex;align-items:center;gap:6px">ðŸ”¥ <span>0 days streak</span></div>
      <div class="row">
        <button class="btn" id="undo">Undo</button>
        <button class="btn" id="save">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit habit modal -->
<div id="edit" class="modal">
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <strong>Edit habit</strong>
      <button class="btn" id="esc2">esc</button>
    </div>
    <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px">
      <input id="ehName" class="field" placeholder="Title"/>
      <select id="ehType" class="field">
        <option value="number">Number</option>
        <option value="checkbox">Checkbox</option>
      </select>
      <input id="ehUnit" class="field" placeholder="Unit (minutes, pages, ...)" />
      <input id="ehColor" class="field" type="color" value="#35c27a" />
      <button class="btn" id="ehSave">Save changes</button>
    </div>
  </div>
</div>

<!-- Embed modal -->
<div id="embed" class="modal">
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <strong>Embed Habit</strong>
      <button class="btn" id="esc3">esc</button>
    </div>
    <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px">
      <label><input type="checkbox" id="emDark" checked/> Notion dark mode</label>
      <label><input type="checkbox" id="emWrite" checked/> Create entries directly on embed</label>
      <button class="btn" id="emCopy">Copy unique link</button>
      <input id="emOut" class="field" readonly/>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  if (qs.get('dark')==='1') document.body.classList.add('dark');
  const EMBED_TOKEN = qs.get('token') || null;
  const EMBED_HABIT = qs.get('habitId') || null;
  const WRITE_OK = qs.get('write') !== '0';

  const API = {
    async list(){ return j(await fetch('/api/habits')); },
    async create(h){ return j(await fetch('/api/habits',{method:'POST', headers:json(), body:JSON.stringify(h)})); },
    async update(h){ return j(await fetch('/api/habits',{method:'PATCH', headers:json(), body:JSON.stringify(h)})); },
    async del(id){ return j(await fetch('/api/habits',{method:'DELETE', headers:json(), body:JSON.stringify({id})})); },
    async heatmap(habitId, mode){ const q = new URLSearchParams(); q.set('habitId',habitId); if (mode==='last365') q.set('last365','1'); else q.set('year',mode); return j(await fetch('/api/heatmap?'+q.toString())); },
    async log(habitId, date, value){ return j(await fetch('/api/log',{method:'POST', headers:json(), body:JSON.stringify({habitId,date,value})})); },
    async reorder(orders){ return j(await fetch('/api/reorder',{method:'POST', headers:json(), body:JSON.stringify({orders})})); },
    async embedLink(habitId, opts){ return j(await fetch('/api/embed',{method:'POST', headers:json(), body:JSON.stringify({habitId, ...opts})})); }
  };
  function json(){ return {'Content-Type':'application/json'}; }
  async function j(r){ if(!r.ok) throw new Error(await r.text()); return await r.json(); }

  const $list = id('list');
  const $q = id('q');
  const $tip = id('tip');

  let HABITS = [];
  let REORDER = false;
  let lastAction = null; // {habitId, date, prev}

  init();

  function applySearch(){ const v = $q.value.toLowerCase(); for(const card of $list.querySelectorAll('.card')){ const t = card.dataset.name.toLowerCase(); card.style.display = t.includes(v)?'block':'none'; } }

  async function init(){
    menu(id('createMenu'));
    id('reorder').onclick = ()=> toggleReorder();
    $q.oninput = applySearch;
    await load();
  }

  async function load(){
    const data = await API.list();
    HABITS = data.habits || [];
    render();
    if (EMBED_HABIT){ // single-card embed mode
      for(const card of $list.querySelectorAll('.card')) if (card.dataset.id !== EMBED_HABIT) card.remove();
      document.querySelector('.top').style.display='none';
    }
  }

  function toggleReorder(){
    REORDER = !REORDER; id('reorder').textContent = REORDER ? 'Save order' : 'Reorder';
    for (const card of $list.querySelectorAll('.card')){
      card.draggable = REORDER;
      card.style.cursor = REORDER ? 'grab' : 'default';
    }
    if (!REORDER){ // save
      const orders = Array.from($list.children).map((el,i)=>({ id:el.dataset.id, order:i }));
      API.reorder(orders).catch(console.error);
    }
  }

  function render(){
    $list.innerHTML = '';
    for (const h of HABITS){
      $list.appendChild(renderCard(h));
    }
    applySearch();
  }

  function renderCard(habit){
    const card = div('card'); card.dataset.id = habit.id; card.dataset.name = habit.name;
    // header
    const hdr = div('hdr');
    const title = div('title'); title.textContent = habit.name.toUpperCase();
    const icons = div('icons');
    const cal = btnIcon('ðŸ“…'); const dots = btnIcon('â‹¯');
    icons.append(cal, dots);
    hdr.append(title, icons);
    card.appendChild(hdr);

    // timeframe state
    let mode = 'last365'; // or year number
    // month bar + heat rows
    const monthbar = div('monthbar'); monthbar.textContent = 'Dec    Jan    Feb    Mar    Apr    May    Jun    Jul    Aug    Sep    Oct    Nov';
    card.appendChild(monthbar);

    const heatWrap = div('row');
    const rowlbls = div('rowlbls'); rowlbls.innerHTML = 'Mon<br>Wed<br>Fri';
    heatWrap.appendChild(rowlbls);
    const heat = div('heat'); heatWrap.appendChild(heat);
    card.appendChild(heatWrap);

    const stats = div('stats'); stats.innerHTML = `<div><span class="tiny k">Streak:</span> <span id="s${habit.id}">0 days</span></div><div><span class="tiny k">Average:</span> <span id="a${habit.id}">0</span> ${habit.unit||''}</div><div><span class="tiny k">Total:</span> <span id="t${habit.id}">0</span> ${habit.unit||''}</div>`;
    card.appendChild(stats);

    const cta = div('cta'); const btn = button('Log today â†’'); cta.appendChild(btn); card.appendChild(cta);

    // card menu (three dots): Edit / Embed / Delete
    dots.onclick = (e)=> openDots(e, habit, card);
    cal.onclick = (e)=> openCalendar(e, habit, (m)=>{ mode = m; refresh(); });

    // drag ordering
    card.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', habit.id));
    card.addEventListener('dragover', e=> { if(REORDER){ e.preventDefault(); const draggingId = e.dataTransfer.getData('text/plain'); const draggingEl = [...$list.children].find(n=>n.dataset.id===draggingId); if(!draggingEl || draggingEl===card) return; const rect = card.getBoundingClientRect(); const before = (e.clientY - rect.top) < rect.height/2; $list.insertBefore(draggingEl, before?card:card.nextSibling);} });

    // load data
    refresh();

    async function refresh(){
      const data = await API.heatmap(habit.id, mode==='last365'?'last365':mode);
      const days = data.days || [];
      // palette
      const pal = buildPalette(data.habit.colorHex || '#35c27a');
      heat.innerHTML='';
      const weeks = chunkWeeks(days);
      for (const wk of weeks){
        const col = div('week');
        for (const d of wk){
          const v = Number(d.value||0); const lvl = level(days, v);
          const c = div('cell'); c.style.background = lvl===0?'#e9edf4':pal[lvl];
          c.dataset.date = d.date; c.dataset.value = v;
          c.onmouseenter = (evt)=> showTip(evt, d.date, v, habit.unit||'');
          c.onmouseleave = ()=> $tip.style.display='none';
          c.onclick = ()=> openLog(habit, new Date(d.date+'T00:00:00'), v, btn, data.stats.streak);
          col.appendChild(c);
        }
        heat.appendChild(col);
      }
      // stats
      id(`s${habit.id}`).textContent = (data.stats.streak||0) + ' days';
      id(`a${habit.id}`).textContent = fmt(data.stats.average||0);
      id(`t${habit.id}`).textContent = fmt(data.stats.total||0);
      // today state button
      const todayKey = ymd(todayLocal());
      const today = days.find(x=>x.date===todayKey);
      const tv = Number(today?.value||0);
      if (tv>0){
        btn.textContent = `Today: ${tv} ${habit.unit||''}  âœ“ âœŽ`;
      } else {
        btn.textContent = 'Log today â†’';
      }
      btn.onclick = ()=> openLog(habit, todayLocal(), tv, btn, data.stats.streak);
    }

    return card;
  }

  function openCalendar(e, habit, onPick){
    const dd = dropdown(e.currentTarget, ['Past 365d', String(new Date().getFullYear())], (v)=>{
      if (v==='Past 365d') onPick('last365'); else onPick(Number(v));
    });
  }

  function openDots(elEvt, habit, card){
    const items = ['Edit','Embed','Delete'];
    const dd = dropdown(elEvt.currentTarget, items, async (v)=>{
      if (v==='Edit') openEdit(habit);
      if (v==='Embed'){
        const r = await API.embedLink(habit.id, { dark:true, canWrite:true });
        id('emOut').value = r.url;
        show('embed', true);
      }
      if (v==='Delete'){
        if (confirm('Delete this habit?')){ await API.del(habit.id); await load(); }
      }
    });
  }

  function openEdit(h){
    id('ehName').value = h.name; id('ehUnit').value = h.unit||''; id('ehType').value = h.type; id('ehColor').value = h.color_hex || '#35c27a';
    show('edit', true);
    id('ehSave').onclick = async()=>{
      await API.update({ id: h.id, name: id('ehName').value, unit: id('ehUnit').value, colorHex: id('ehColor').value });
      show('edit', false); await load();
    };
  }

  function openLog(habit, dateObj, currentValue, btn, streak){
    id('lpHabit').textContent = habit.name;
    id('dot').style.background = habit.color_hex || '#f2c14e';
    const dtLbl = dateObj.toLocaleDateString(undefined, { weekday:'short', year:'numeric', month:'short', day:'numeric' });
    id('lpDate').textContent = dtLbl;
    const wrap = id('lpValWrap'); const input = id('lpVal');
    if (habit.type === 'checkbox'){ wrap.style.display='none'; } else { wrap.style.display='block'; input.placeholder = habit.unit || 'units'; input.value = currentValue||0; }
    id('lpStreak').querySelector('span').textContent = `${streak||0} days streak`;
    show('logPop', true);

    id('save').onclick = async()=>{
      const val = habit.type==='checkbox' ? 1 : Number(input.value||0);
      const date = ymd(dateObj);
      lastAction = { habitId: habit.id, date, prev: currentValue||0 };
      await API.log(habit.id, date, val);
      show('logPop', false); await load();
    };
    id('undo').onclick = async()=>{
      if (!lastAction) return;
      await API.log(lastAction.habitId, lastAction.date, lastAction.prev||0);
      lastAction = null; show('logPop', false); await load();
    };
  }

  // helpers
  function buildPalette(hex){
    const [h,s,l] = hexToHsl(hex||'#35c27a');
    return {
      1: hslToHex(h, s, clamp01(l*0.62)),
      2: hslToHex(h, s, clamp01(l*0.76)),
      3: hslToHex(h, s, clamp01(l*0.9)),
      4: hslToHex(h, s, clamp01(Math.min(0.98, l*1.06)))
    };
  }
  function level(days, v){
    if (v<=0) return 0;
    const vals = days.map(d=>Number(d.value)||0).filter(x=>x>0).sort((a,b)=>a-b);
    if (vals.length<5) return 1;
    const q = p => vals[Math.floor((vals.length-1)*p)];
    const S=[0,q(0.2),q(0.4),q(0.6),q(0.8)];
    if (v>S[4]) return 4; if (v>S[3]) return 3; if (v>S[2]) return 2; return 1;
  }
  function chunkWeeks(days){ const w=[]; let buf=[]; for(let i=0;i<days.length;i++){ buf.push(days[i]); if (buf.length===7){ w.push(buf); buf=[]; } } if (buf.length) w.push(buf); return w; }
  function showTip(evt, date, value, unit){ const s = `${value||0} ${unit||''}`.trim(); $tip.textContent = `${s || '0'}\n${new Date(date+'T00:00:00').toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric', year:'numeric' })}`; $tip.style.display='block'; $tip.style.left=evt.clientX+12+'px'; $tip.style.top=evt.clientY-12+'px'; }
  function todayLocal(){ const n=new Date(); return new Date(n.getFullYear(),n.getMonth(),n.getDate()); }
  function ymd(d){ const z=n=>n<10?'0'+n:n; return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
  function fmt(n){ return (Math.round(n*100)/100).toString(); }
  function id(s){ return document.getElementById(s); }
  function div(c){ const n=document.createElement('div'); if(c) n.className=c; return n; }
  function button(t){ const n=document.createElement('button'); n.className='btn'; n.textContent=t; return n; }
  function btnIcon(c){ const n=document.createElement('button'); n.className='iconbtn'; n.textContent=c; return n; }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function hexToHsl(hex){ const [r,g,b]=hexToRgb(hex).map(x=>x/255); const max=Math.max(r,g,b),min=Math.min(r,g,b); let h,s,l=(max+min)/2; if(max===min){h=s=0;} else { const d=max-min; s=l>0.5? d/(2-max-min): d/(max+min); switch(max){ case r:h=(g-b)/d+(g<b?6:0);break; case g:h=(b-r)/d+2;break; case b:h=(r-g)/d+4;break;} h/=6;} return [h,s,l]; }
  function hexToRgb(hex){ const h=hex.replace('#',''); return [parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16),parseInt(h.slice(4,6),16)]; }
  function hslToHex(h,s,l){ const rgb=hslToRgb(h,s,l).map(x=>Math.round(x*255)); return '#'+rgb.map(x=>x.toString(16).padStart(2,'0')).join(''); }
  function hslToRgb(h,s,l){ let r,g,b; if(s===0){ r=g=b=l; } else { const hue2rgb=(p,q,t)=>{ if(t<0)t+=1; if(t>1)t-=1; if(t<1/6)return p+(q-p)*6*t; if(t<1/2)return q; if(t<2/3)return p+(q-p)*(2/3-t)*6; return p; }; const q=l<0.5? l*(1+s): l+s-l*s; const p=2*l-q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3); } return [r,g,b]; }

  // dropdown helper
  function dropdown(anchor, items, onPick){
    const wrap = document.createElement('div'); wrap.style.position='absolute'; wrap.style.zIndex='40'; wrap.style.background='var(--card)'; wrap.style.border='1px solid var(--line)'; wrap.style.borderRadius='12px'; wrap.style.padding='6px 0';
    items.forEach(txt=>{ const it=document.createElement('div'); it.textContent=txt; it.style.padding='8px 12px'; it.style.cursor='pointer'; it.onmouseenter=()=>it.style.background='var(--chip)'; it.onmouseleave=()=>it.style.background='transparent'; it.onclick=()=>{ document.body.removeChild(wrap); onPick(txt); }; wrap.appendChild(it); });
    document.body.appendChild(wrap); const r=anchor.getBoundingClientRect(); wrap.style.left=(r.right-160)+'px'; wrap.style.top=(r.bottom+6)+'px';
    const onDoc = (e)=>{ if(!wrap.contains(e.target)){ document.body.removeChild(wrap); document.removeEventListener('click', onDoc); } }; setTimeout(()=>document.addEventListener('click', onDoc),0);
    return wrap;
  }

  // simple menu
  function menu(el){ const btn = el.querySelector('button'); const dd = el.querySelector('.dd'); btn.onclick = ()=> el.classList.toggle('open'); el.querySelectorAll('.item').forEach(it=> it.onclick = async()=>{ el.classList.remove('open'); const type = it.dataset.type; const name = prompt('Name the habit'); if(!name) return; let unit=''; if (type==='number'){ unit = prompt('Unit (e.g., minutes)') || ''; } const color = '#35c27a'; const r = await API.create({ name, type, unit, colorHex: color }); await load(); }); }

  function show(idv, on){ const m = document.getElementById(idv); m.style.display = on ? 'flex' : 'none'; }
  id('esc1').onclick=()=>show('logPop',false); id('esc2').onclick=()=>show('edit',false); id('esc3').onclick=()=>show('embed',false);
})();
</script>
</body>
</html>
