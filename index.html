<!doctype html>
<html lang='en'>
<head>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>Heatmap Habits</title>
<style>
:root{ --bg:#f7f8fb; --card:#fff; --ink:#0d1421; --muted:#5d6b83; --line:#e6e9f0;
       --chip:#f1f4f9; --cell:#e9edf4; --cell-edge:#d7dfea44; --ok:#23b26b; --danger:#e25555; --grey:#8a94a6; --hover-border:#cbd4e1; }
.dark,:root.dark{ --bg:#191919; --card:#191919; --ink:#e7edf6; --muted:#c6d0df; --line:#1f2633;
       --chip:#0f1622; --cell:#2a3344; --cell-edge:#101521; --ok:#41d78f; --danger:#ff6a6a; --grey:#a9b3c2; --hover-border:#2a3344; }
body.embed:not(.dark){
  --bg:#f7f8fb; --card:#fff; --ink:#0d1421; --muted:#5d6b83; --line:#e6e9f0;
  --chip:#f1f4f9; --cell:#e9edf4; --cell-edge:#d7dfea44; --ok:#23b26b; --danger:#e25555; --grey:#8a94a6; --hover-border:#cbd4e1;
}
body.embed.dark{
  --bg:#191919; --card:#191919; --ink:#f3f3f3; --muted:#b5b5b5; --line:#2b2b2b;
  --chip:#232323; --cell:#272727; --cell-edge:#141414; --grey:#d8d8d8; --hover-border:#3a3a3a;
}
html{margin:0;min-height:100%;background:var(--bg);color:var(--ink);font:14px/1.35 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{margin:0;min-height:100%;background:var(--bg);color:inherit;font:inherit}
body:not(.embed){background-image:radial-gradient(circle,#d8dce5 1px,transparent 2px);background-size:40px 40px;background-attachment:fixed}
*,*:before,*:after{box-sizing:border-box}
 .wrap{max-width:1100px;margin:0 auto;padding:100px;overflow:hidden}
body.embed .wrap{padding:18px}
.top{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.search{flex:1;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:var(--ink);min-width:140px}
.btn{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px 12px;cursor:pointer;color:var(--ink);transition:background .2s,border-color .2s,box-shadow .2s,transform .1s}
.btn:hover{background:rgba(255,255,255,.04);border-color:var(--hover-border);box-shadow:0 6px 18px rgba(13,20,33,.15);transform:translateY(-1px)}
.dark .btn:hover{box-shadow:0 6px 24px rgba(0,0,0,.55)}
.btn.success{background:var(--ok);border-color:var(--ok);color:#0b0f14}
.btn.danger{background:var(--danger);border-color:var(--danger);color:#0b0f14}
.grid{display:flex;flex-direction:column;gap:18px}
.box{position:relative;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:32px;overflow:hidden}
body.embed .box{border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 26px rgba(0,0,0,.25)}
.embed.dark .box{border:1px solid #2b2b2b;background:var(--card);box-shadow:none}
.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.title{font-weight:800;letter-spacing:.2px;font-size:26px}
.icons{display:flex;gap:8px}
.iconbtn{background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;display:grid;place-items:center;color:var(--grey);transition:background .2s,color .2s,border-color .2s,box-shadow .2s,transform .1s}
.iconbtn:hover{background:rgba(255,255,255,.05);border-color:var(--hover-border);color:var(--ink);box-shadow:0 6px 18px rgba(13,20,33,.18);transform:translateY(-1px)}
.dark .iconbtn:hover{box-shadow:0 12px 28px rgba(0,0,0,.6)}
.iconbtn:active{transform:translateY(1px)}
.iconbtn svg{width:18px;height:18px}
.months{position:relative;height:18px;margin:12px 0 2px 0;overflow:hidden;padding:0 24px 0 40px}
.monthsInner{display:grid;grid-auto-flow:column;grid-auto-columns:16px;gap:6px;color:var(--muted);font-size:12px;align-items:end;will-change:transform}
.monthsInner .m{grid-row:1}
.row{display:flex;align-items:flex-start;overflow:auto;padding-right:24px}
.rowlbls{color:var(--muted);font-size:12px;width:34px;margin-right:6px;display:grid;grid-template-rows:repeat(7,16px);gap:6px;flex:0 0 auto}
.heat{display:grid;grid-auto-flow:column;grid-auto-columns:16px;gap:6px;grid-template-rows:repeat(7,16px);padding:4px 24px 4px 0;margin-right:16px;flex:1 1 auto;min-height:140px;max-width:100%}
.cell{width:16px;height:16px;border-radius:3px;background:var(--cell);outline:1px solid var(--cell-edge);cursor:pointer;transition:opacity .1s,transform .1s,box-shadow .2s}
.cell:hover{opacity:.95;transform:translateY(-1px);box-shadow:0 6px 12px rgba(0,0,0,.25)}
.statsWrap{display:flex;justify-content:space-between;align-items:flex-end;gap:18px;margin-top:26px}
.stats{display:flex;flex-direction:column;gap:10px}
.statsWrap .stats{flex:1}
.stats .k{color:var(--muted)}
.stats .v{color:var(--ink);font-weight:800}
.cta{margin:0;display:flex;justify-content:flex-end;align-items:flex-end;flex-shrink:0}
.cta .btn{font-weight:800}
.todayDone{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:8px 12px;display:flex;align-items:center;gap:8px;color:var(--ink);font-weight:800}
.check{width:18px;height:18px;border-radius:50%;background:var(--ok);display:inline-grid;place-items:center;color:#0b0f14;font-weight:900}
.check:after{content:'‚úì';font-size:12px;line-height:1}
.modal,.pop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
.panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;min-width:360px;max-width:min(520px,92vw);color:var(--ink);overflow:hidden}
.rowx{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.field{width:100%;background:var(--chip);color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;min-width:0;max-width:100%}
select.field[disabled]{background:var(--chip);color:var(--muted);cursor:default;appearance:none;-webkit-appearance:none}
.tiny{color:var(--muted);font-size:12px}
.kbd{background:#232a38;color:#e8eef6;border:1px solid #3a4356;border-radius:6px;padding:2px 6px;font-size:12px}
.dark .kbd{background:#1b2230}
.dd.floating{position:absolute;background:var(--card);border:1px solid var(--line);border-radius:12px;min-width:240px;z-index:60;overflow:hidden;box-shadow:0 6px 28px rgba(0,0,0,.25)}
.dd.floating .item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer;color:var(--ink);transition:background .1s}
.dd.floating .item:last-child{border-bottom:none}
.dd.floating .item:hover{background:rgba(255,255,255,.06)}
body:not(.embed) .dd.floating .item:hover{background:var(--chip);color:var(--ink)}
.dd.floating .item.delete{color:var(--danger)}
.dd.floating svg{width:16px;height:16px}
.tooltip{position:fixed;pointer-events:none;background:var(--card);border:1px solid var(--line);padding:6px 9px;border-radius:8px;font-size:12px;color:var(--ink);display:none;z-index:100;white-space:pre}
body.embed.dark .wrap{background:#191919;border-radius:18px}
body.embed.dark .rowlbls,body.embed.dark .monthsInner{color:#a5a5a5}
body.embed.dark .heat{padding:8px 24px 8px 0;margin-right:16px}
body.embed.dark .cell{background:#252525;outline:1px solid #2f2f2f}
body.embed.dark .stats .k{color:#bcbcbc}
body.embed.dark .statsWrap{border-top:1px solid rgba(255,255,255,.08);padding-top:18px;margin-top:32px}
body.embed.dark .todayDone{background:#262626;border-color:#343434;color:#f3f3f3}
body.embed.dark .tooltip{background:#202020;border-color:#353535;color:#f3f3f3}
body.embed.dark .btn:not(.success):not(.danger){background:#232323;border-color:#343434;color:#f3f3f3}
body.embed.dark .btn:not(.success):not(.danger):hover{background:#2a2a2a}
</style>
</head>
<body>
<div id='root' class='wrap'>
  <div class='top'>
    <input id='q' class='search' placeholder='Search habits'/>
    <button class='btn' id='reorder'>Reorder</button>
    <div class='menu' id='createMenu'>
      <button class='btn'>Create Habit ‚ñæ</button>
    </div>
  </div>
  <div id='list' class='grid'></div>
</div>
<div id='tip' class='tooltip'></div>
<div id='logPop' class='pop'>
  <div class='panel'>
    <div class='rowx' style='justify-content:space-between'><div class='rowx'><div id='dot' style='width:10px;height:10px;border-radius:50%;background:#f2c14e'></div><strong id='lpHabit' style='margin-left:6px'></strong></div><button class='btn kbd' id='esc1'>esc</button></div>
    <div class='tiny' style='margin-top:12px'>Date:</div>
    <div id='lpDate' style='margin:6px 0 10px 0;font-weight:700'></div>
    <div id='lpValWrap'><input id='lpVal' class='field' type='number' min='0' step='1' placeholder='minutes'/></div>
    <div style='display:flex;justify-content:space-between;align-items:center;margin-top:14px'>
      <div id='lpStreak' class='tiny' style='display:flex;align-items:center;gap:6px'>üî• <span>0 days </span></div>
      <div class='rowx'><button class='btn danger' id='undo' style='display:none'>Undo</button><button class='btn success' id='save'>Save</button></div>
    </div>
  </div>
</div>
<div id='edit' class='modal'>
  <div class='panel'>
    <div class='rowx' style='justify-content:space-between'><strong>Edit Habit</strong><button class='btn kbd' id='esc2'>esc</button></div>
    <div style='display:flex;flex-direction:column;gap:10px;margin-top:12px'>
      <input id='ehName' class='field' placeholder='Title'/>
      <select id='ehType' class='field' disabled><option value='number'>Number</option><option value='checkbox'>Checkbox</option></select>
      <input id='ehUnit' class='field' placeholder='Unit (minutes, pages, ...)'/>
      <input id='ehColor' class='field' type='color' value='#35c27a'/>
      <div><div class='tiny' style='margin:8px 0 6px'>Calculate streak only on:</div><div class='days7' id='ehDays' style='display:grid;grid-template-columns:repeat(2,1fr);gap:8px 18px;'></div></div>
      <button class='btn success' id='ehSave'>Save Changes</button>
    </div>
  </div>
</div>
<div id='embed' class='modal'>
  <div class='panel'>
    <div class='rowx' style='justify-content:space-between'><strong>Embed Habit</strong><button class='btn kbd' id='esc3'>esc</button></div>
    <div style='display:flex;flex-direction:column;gap:10px;margin-top:12px'>
      <label><input type='checkbox' id='emDark' checked/> Notion dark mode</label>
      <label><input type='checkbox' id='emWrite' checked/> Create entries directly on embed</label>
      <button class='btn' id='emCopy'><span id='emCopyText'>Copy unique link</span></button>
      <div class='tiny'>Paste into Notion‚Äôs ‚Äú/Embed‚Äù.</div>
    </div>
  </div>
</div>
<script>
(function(){
  const qs=new URLSearchParams(location.search);
  if(qs.get('dark')==='1') document.body.classList.add('dark');
  if(qs.get('embed')==='1') document.body.classList.add('embed');
  const EMBED_HABIT = qs.get('habitId') || null;

  const API={
    async list(){return j(await fetch('/api/habits'))},
    async create(h){return j(await fetch('/api/habits',{method:'POST',headers:json(),body:JSON.stringify(h)}))},
    async update(h){return j(await fetch('/api/habits',{method:'PATCH',headers:json(),body:JSON.stringify(h)}))},
    async del(id){return j(await fetch('/api/habits',{method:'DELETE',headers:json(),body:JSON.stringify({id})}))},
    async heatmap(habitId,mode){const q=new URLSearchParams();q.set('habitId',habitId);if(mode==='last365')q.set('last365','1');else q.set('year',mode);return j(await fetch('/api/heatmap?'+q.toString()))},
    async log(habitId,date,value){return j(await fetch('/api/log',{method:'POST',headers:json(),body:JSON.stringify({habitId,date,value})}))},
    async reorder(orders){return j(await fetch('/api/reorder',{method:'POST',headers:json(),body:JSON.stringify({orders})}))},
    async embedLink(habitId,opts){return j(await fetch('/api/embed',{method:'POST',headers:json(),body:JSON.stringify({habitId,...opts})}))}
  };

  const $list = id('list'), $q = id('q'), $tip = id('tip');
  let HABITS=[], REORDER=false;

  const Pop={el:null,align:'right', open(anchor,container,builder,align='right'){ this.close(); this.align=align; this.el=builder(); container.appendChild(this.el); position(this.el,anchor,container,this.align); setTimeout(()=>{const onDown=(e)=>{if(!this.el.contains(e.target)&&e.target!==anchor) this.close()}; document.addEventListener('pointerdown',onDown,{once:true})})}, close(){ if(this.el){ this.el.remove(); this.el=null; } }};

  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ Pop.close(); ['logPop','edit','embed'].forEach(s=>show(s,false)); } });
  id('esc1').onclick=()=>show('logPop',false);
  id('esc2').onclick=()=>show('edit',false);
  id('esc3').onclick=()=>show('embed',false);

  init();

  function json(){return{'Content-Type':'application/json'}}
  async function j(r){ if(!r.ok) throw new Error(await r.text()); return await r.json(); }
  function id(s){return document.getElementById(s)}
  function div(c){const n=document.createElement('div'); if(c) n.className=c; return n}
  function button(t){const n=document.createElement('button'); n.className='btn'; n.textContent=t; return n}
  function iconBtn(svg){const b=document.createElement('button'); b.className='iconbtn'; b.innerHTML=svg; b.addEventListener('pointerdown',(e)=>e.preventDefault()); return b}

  function init(){ menu(id('createMenu')); id('reorder').onclick=()=>toggleReorder(); $q.oninput=applySearch; load(); }

  async function load(){ const data = await API.list(); HABITS = data.habits||[]; render(); if(EMBED_HABIT){ for(const card of $list.querySelectorAll('.card')) if(card.dataset.id!==EMBED_HABIT) card.remove(); document.querySelector('.top').style.display='none'; } }

  function applySearch(){ const v=($q.value||'').toLowerCase(); for(const card of $list.querySelectorAll('.card')){ const t=card.dataset.name.toLowerCase(); card.style.display=t.includes(v)?'block':'none' } }

  function toggleReorder(){ REORDER=!REORDER; id('reorder').textContent=REORDER?'Save order':'Reorder'; for(const card of $list.querySelectorAll('.card')){ card.draggable=REORDER; card.style.cursor=REORDER?'grab':'default'; } if(!REORDER){ const orders=Array.from($list.children).map((el,i)=>({id:el.dataset.id,order:i})); API.reorder(orders).catch(console.error); } }

  function render(){ $list.innerHTML=''; for(const h of HABITS){ $list.appendChild(renderCard(h)); } applySearch(); }

  function renderCard(h){
    const host=div('card');
    const card=div('box');
    host.appendChild(card);
    host.dataset.id=h.id; host.dataset.name=h.name;

    const hdr=div('hdr');
    const title=div('title'); title.textContent=h.name.toUpperCase();
    const icons=div('icons');
    const cal=iconBtn(`<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="17" rx="3" stroke="currentColor" stroke-width="2"/><path d="M8 2v4M16 2v4M3 10h18" stroke="currentColor" stroke-width="2"/></svg>`);
    const dots=iconBtn(`<svg viewBox="0 0 24 24" fill="none"><circle cx="5" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="19" cy="12" r="2" fill="currentColor"/></svg>`);
    icons.append(cal,dots);
    hdr.append(title,icons); card.appendChild(hdr);

    const months=div('months');
    const monthsInner=document.createElement('div'); monthsInner.className='monthsInner'; months.appendChild(monthsInner);
    card.appendChild(months);

    let mode='last365';
    const heatWrap=div('row');
    const rowlbls=div('rowlbls'); rowlbls.innerHTML=`<span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>`;
    heatWrap.appendChild(rowlbls);
    const heat=div('heat'); heatWrap.appendChild(heat);
    card.appendChild(heatWrap);

    const unitText=(h.unit||'').trim();
    const stats=div('stats');
    let statsHtml=`
      <div><span class='k'>Streak:</span> <span class='v' id='s${h.id}'>0 days</span></div>`;
    if(h.type!=='checkbox'){
      statsHtml+=`<div><span class='k'>Average:</span> <span class='v' id='a${h.id}'>0${unitText?' '+unitText:''}</span></div>`;
    }
    statsHtml+=`<div><span class='k'>Total:</span> <span class='v' id='t${h.id}'>0${unitText?' '+unitText:''}</span></div>`;
    stats.innerHTML=statsHtml;
    const statsWrap=div('statsWrap');
    statsWrap.appendChild(stats);

    const cta=div('cta'); const btn=button('Log Today ‚Üí'); cta.appendChild(btn);
    statsWrap.appendChild(cta);
    card.appendChild(statsWrap);

    cal.addEventListener('pointerdown',(e)=>{ e.preventDefault(); Pop.open(cal,card,()=>calendarDD(mode,(m)=>{ mode=m; refresh(); })) });
    dots.addEventListener('pointerdown',(e)=>{ e.preventDefault(); Pop.open(dots,card,()=>dotsDD(h)); });

    host.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',h.id));
    host.addEventListener('dragover',e=>{ if(REORDER){ e.preventDefault(); const draggingId=e.dataTransfer.getData('text/plain'); const draggingEl=[...$list.children].find(n=>n.dataset.id===draggingId); if(!draggingEl||draggingEl===host) return; const rect=host.getBoundingClientRect(); const before=(e.clientY-rect.top)<rect.height/2; $list.insertBefore(draggingEl,before?host:host.nextSibling); } });

    heatWrap.addEventListener('scroll',()=>{
      monthsInner.style.transform = `translateX(${-heatWrap.scrollLeft}px)`;
    });

    refresh();

    async function refresh(){
      const data=await API.heatmap(h.id,mode==='last365'?'last365':mode);
      const days=data.days||[];
      const aligned=alignToMonday(days);
      const weeks=chunkWeeks(aligned);

      monthsInner.innerHTML='';
      monthsInner.style.gridTemplateColumns = `repeat(${weeks.length},16px)`;
      const moIdx=monthStarts(aligned);
      for(let w=0; w<weeks.length; w++){
        const mName=moIdx.get(w);
        const cell=div('m'); cell.textContent=mName||''; monthsInner.appendChild(cell);
      }

      heat.innerHTML='';
      heat.style.gridTemplateColumns=`repeat(${weeks.length},16px)`;
      const pal=buildPalette(data.habit.colorHex||'#35c27a');
      for(const wk of weeks){
        for(let r=0;r<7;r++){
          const d=wk[r];
          const v=Number(d?.value||0);
          const lvl=level(aligned,v);
          const c=div('cell');
          c.style.background=(lvl===0)?'var(--cell)':pal[lvl];
          if(d){
            c.dataset.date=d.date; c.dataset.value=v;
            c.onmouseenter=(evt)=>showTip(evt,d.date,v,h.unit||'');
            c.onmouseleave=()=>$tip.style.display='none';
            c.onclick=()=>openLog(h,new Date(d.date+'T00:00:00'),v,btn,data.stats.streak,data.stats.continuesToday);
          } else {
            c.style.opacity=.25;
          }
          heat.appendChild(c);
        }
      }

      const streakText=(data.stats.streak||0)+' days';
      id(`s${h.id}`).textContent=streakText;
      const avgEl=id(`a${h.id}`);
      if(avgEl){
        avgEl.textContent=fmt(data.stats.average||0)+(unitText?' '+unitText:'');
      }
      id(`t${h.id}`).textContent=fmt(data.stats.total||0)+(unitText?' '+unitText:'');

      const todayKey=ymd(todayLocal());
      const tRow = days.find(x=>x.date===todayKey);
      const tv=Number(tRow?.value||0);
      if(tv>0){
        btn.innerHTML=`Today: <strong>${tv} ${h.unit||''}</strong> <span class='check'></span>`;
      } else {
        btn.innerHTML='<strong>Log Today</strong> ‚Üí';
      }
      btn.onclick=()=>openLog(h,todayLocal(),tv,btn,data.stats.streak,data.stats.continuesToday);
    }

    return host;
  }

  function calendarDD(current,onPick){
    const dd=document.createElement('div'); dd.className='dd floating';
    ['Past 365 days', String(new Date().getFullYear())].forEach(label=>{
      const it=document.createElement('div'); it.className='item'; it.textContent=label;
      it.onclick=()=>{ Pop.close(); onPick(label==='Past 365 days'?'last365':Number(label)); };
      dd.appendChild(it);
    });
    return dd;
  }

  function dotsDD(h){
    const dd=document.createElement('div'); dd.className='dd floating';
    [{label:'Edit'},{label:'Embed'},{label:'Delete',delete:true}].forEach(obj=>{
      const it=document.createElement('div'); it.className='item'+(obj.delete?' delete':''); it.textContent=obj.label;
      it.onclick=async()=>{ Pop.close(); if(obj.label==='Edit') openEdit(h); if(obj.label==='Embed') openEmbed(h); if(obj.label==='Delete'){ if(confirm('Delete this habit?')){ await API.del(h.id); await load(); } } };
      dd.appendChild(it);
    });
    return dd;
  }

  function position(wrap,anchor,container,align='right'){
    const ar=anchor.getBoundingClientRect();
    const cr=container.getBoundingClientRect();
    const width=240;
    let left=(align==='left')?(ar.left-cr.left):(ar.right-cr.left)-width;
    if(left<8) left=8;
    let top=(ar.bottom-cr.top)+6;
    wrap.style.left=left+'px';
    wrap.style.top=top+'px';
    requestAnimationFrame(()=>{
      const wr=wrap.getBoundingClientRect();
      let dx=0,dy=0;
      if(wr.right>cr.right) dx=cr.right-wr.right-8;
      if(wr.left<cr.left) dx=cr.left-wr.left+8;
      if(wr.bottom>cr.bottom) dy=-((wr.height)+12);
      if(wr.top<cr.top) dy=(ar.bottom-wr.top)+6;
      if(dx||dy){ wrap.style.left=(left+dx)+'px'; wrap.style.top=(top+dy)+'px'; }
    });
  }

  function openEmbed(h){
    show('embed',true);
    const btn=id('emCopy'), label=id('emCopyText');
    label.textContent='Copy unique link';
    btn.onclick=async()=>{
      try{
        const r=await API.embedLink(h.id,{dark:id('emDark').checked,canWrite:id('emWrite').checked});
        await navigator.clipboard.writeText(r.url);
        label.textContent='Copied!';
        setTimeout(()=>label.textContent='Copy unique link',2000);
      }catch(e){ console.error(e); }
    };
  }

  function openEdit(h){
    id('ehName').value=h.name;
    id('ehType').value=h.type;
    id('ehUnit').value=h.type==='number'?(h.unit||''):'';
    id('ehUnit').style.display=(h.type==='number')?'block':'none';
    id('ehColor').value=h.color_hex||'#35c27a';

    const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const sel=new Set(h.streak_days||days);
    const box=id('ehDays'); box.innerHTML='';
    days.forEach(d=>{ const lab=document.createElement('label'); lab.innerHTML=`<input type='checkbox' value='${d}' ${sel.has(d)?'checked':''}/> ${d}`; box.appendChild(lab); });
    id('ehType').onchange=()=>{ const t=id('ehType').value; id('ehUnit').style.display=(t==='number')?'block':'none'; }

    show('edit',true);
    id('ehSave').onclick=async()=>{
      const streakDays=[...box.querySelectorAll('input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
      await API.update({id:h.id,name:id('ehName').value,unit:id('ehType').value==='number'?id('ehUnit').value:'',colorHex:id('ehColor').value,streakDays});
      show('edit',false); await load();
    };
  }

  function openLog(habit,dateObj,currentValue,btn,streak,continuesToday){
    id('lpHabit').textContent=habit.name;
    id('dot').style.background=habit.color_hex||'#f2c14e';
    id('lpDate').textContent=dateObj.toLocaleDateString(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric'});

    const wrap=id('lpValWrap'); const input=id('lpVal');
    const isCheckbox=habit.type==='checkbox';
    wrap.style.display=isCheckbox?'none':'block';
    if(!isCheckbox){ input.placeholder=habit.unit||'units'; input.value=currentValue>0?currentValue:''; }

    id('lpStreak').querySelector('span').textContent=`${streak||0} days`;

    const $undo=id('undo'); $undo.style.display=(currentValue>0)?'inline-block':'none';
    show('logPop',true);

    id('save').onclick=async()=>{
      const val=isCheckbox?1:Number(input.value||0);
      await API.log(habit.id,ymd(dateObj),val);
      show('logPop',false); await load();
    };
    $undo.onclick=async()=>{
      await API.log(habit.id,ymd(dateObj),0);
      show('logPop',false); await load();
    };
  }

  function buildPalette(hex){ const [h,s,l]=hexToHsl(hex||'#35c27a'); return {1:hslToHex(h,Math.min(1,s),cl(l*0.92)),2:hslToHex(h,Math.min(1,s),cl(l*0.80)),3:hslToHex(h,Math.min(1,s),cl(l*0.68)),4:hslToHex(h,Math.min(1,s),cl(l*0.58))}; }
  function level(days,v){ if(v<=0) return 0; const vals=days.map(d=>(d?Number(d.value)||0:0)).filter(x=>x>0).sort((a,b)=>a-b); if(vals.length<5) return 1; const q=p=>vals[Math.floor((vals.length-1)*p)]; const S=[0,q(.2),q(.4),q(.6),q(.8)]; if(v>S[4])return 4; if(v>S[3])return 3; if(v>S[2])return 2; return 1; }
  function alignToMonday(days){ const out=days.slice(); if(!out.length) return out; const first=new Date(out[0].date+'T00:00:00'); const dow=first.getDay(); const need=(dow===1)?0:((dow===0)?6:(dow-1)); return Array(need).fill(null).concat(out); }
  function chunkWeeks(days){ const weeks=[]; let buf=[]; for(let i=0;i<days.length;i++){ buf.push(days[i]); if(buf.length===7){ weeks.push(buf); buf=[]; } } if(buf.length){ while(buf.length<7) buf.push(null); weeks.push(buf); } return weeks; }
  function monthStarts(days){ const map=new Map(); const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; for(let i=0;i<days.length;i++){ const d=days[i]; if(!d) continue; const dt=new Date(d.date+'T00:00:00'); if(dt.getDate()===1){ const weekIdx=Math.floor(i/7); map.set(weekIdx,months[dt.getMonth()]); } } return map; }

  function showTip(evt,date,value,unit){
    const s=`${value||0} ${unit||''}`.trim();
    const t=id('tip');
    t.innerHTML=`<strong>${s||'0'}</strong><br>${new Date(date+'T00:00:00').toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric',year:'numeric'})}`;
    t.style.display='block';
    t.style.left=evt.clientX+12+'px';
    t.style.top=evt.clientY-12+'px';
  }
  function todayLocal(){ const n=new Date(); return new Date(n.getFullYear(),n.getMonth(),n.getDate()); }
  function ymd(d){ const z=n=>n<10?'0'+n:n; return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
  function fmt(n){ return (Math.round(n*100)/100).toString(); }
  function show(idv,on){ const m=document.getElementById(idv); m.style.display=on?'flex':'none'; }
  function cl(x){ return Math.max(0,Math.min(1,x)); }
  function hexToHsl(hex){ const [r,g,b]=hexToRgb(hex).map(x=>x/255); const max=Math.max(r,g,b),min=Math.min(r,g,b); let h,s,l=(max+min)/2; if(max===min){ h=s=0 } else { const d=max-min; s=l>0.5?d/(2-max-min):d/(max+min); switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break} h/=6 } return [h,s,l]; }
  function hexToRgb(hex){ const h=hex.replace('#',''); return [parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16),parseInt(h.slice(4,6),16)]; }
  function hslToHex(h,s,l){ const rgb=hslToRgb(h,s,l).map(x=>Math.round(x*255)); return '#'+rgb.map(x=>x.toString(16).padStart(2,'0')).join(''); }
  function hslToRgb(h,s,l){ let r,g,b; if(s===0){ r=g=b=l } else { const hue2rgb=(p,q,t)=>{ if(t<0)t+=1; if(t>1)t-=1; if(t<1/6)return p+(q-p)*6*t; if(t<1/2)return q; if(t<2/3)return p+(q-p)*(2/3-t)*6; return p; }; const q=l<0.5?l*(1+s):l+s-l*s; const p=2*l-q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3); } return [r,g,b]; }

  function menu(root){
    const btn=root.querySelector('button');
    const container=document.body;
    const buildMenu=()=>{
      const dd=document.createElement('div'); dd.className='dd floating';
      [{label:'Number',type:'number'},{label:'Checkbox',type:'checkbox'}].forEach(opt=>{
        const it=document.createElement('div'); it.className='item'; it.textContent=opt.label;
        it.onclick=async()=>{
          Pop.close();
          const name=prompt('Name your habit'); if(!name) return;
          let unit='';
          if(opt.type==='number') unit=prompt('Unit (e.g., minutes, pages, km)')||'';
          await API.create({name,type:opt.type,unit}); await load();
        };
        dd.appendChild(it);
      });
      return dd;
    };
    btn.addEventListener('pointerdown',e=>{
      e.preventDefault();
      Pop.open(btn,container,buildMenu,'right');
    });
  }
})();
</script>
</body>
</html>
