<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Heatmap Habits</title>
  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --ink:#0d1421; --muted:#5d6b83; --line:#e6e9f0; --chip:#f1f4f9;
      --cell:#e9edf4; --cell-edge:#d7dfea44;
      --ok:#23b26b; --danger:#e25555; --accent:#6b7cff; --grey:#8a94a6;
    }
    .dark, .dark:root{
      --bg:#0b0e14; --card:#141a23; --ink:#e7edf6; --muted:#c6d0df; --line:#1f2633; --chip:#0f1622;
      --cell:#2a3344; --cell-edge:#0e1118;
      --ok:#41d78f; --danger:#ff6a6a; --accent:#a6b8ff; --grey:#9aa4af;
    }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--ink);
      font:14px/1.35 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; overflow:hidden; }
    .top{ display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .search{ flex:1; background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px 12px; color:var(--ink); min-width:140px; }
    .btn{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:10px 12px; cursor:pointer; color:var(--ink); }
    .btn:hover{ border-color:#cbd4e1; }
    .btn.success{ background:var(--ok); border-color:var(--ok); color:#0b0f14; }
    .btn.danger{ background:var(--danger); border-color:var(--danger); color:#0b0f14; }

    .menu{ position:relative; }
    .menu .dd{ position:absolute; right:0; top:110%; background:var(--card); border:1px solid var(--line);
      border-radius:12px; min-width:220px; display:none; z-index:30; overflow:hidden; }
    .menu.open .dd{ display:block; }
    .dd .item{ display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer; border-bottom:1px solid var(--line); color:var(--ink); }
    .dd .item:last-child{ border-bottom:none; }

    .grid{ display:flex; flex-direction:column; gap:18px; }

    .card{ }
    .box{ position:relative; background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; overflow:hidden; }

    .hdr{ display:flex; align-items:center; justify-content:space-between; }
    .title{ font-weight:800; letter-spacing:0.2px; font-size:26px; }
    .icons{ display:flex; gap:8px; }
    .iconbtn{
      background:var(--chip); border:1px solid var(--line); border-radius:10px; padding:8px; cursor:pointer;
      display:grid; place-items:center; color:var(--grey);
    }
    .iconbtn svg{ width:18px; height:18px; }

    .months{ display:grid; grid-auto-flow:column; grid-auto-columns:16px; gap:6px;
      color:var(--muted); font-size:12px; margin:6px 2px 2px; align-items:end; }
    .months .m{ grid-row:1; }

    .row{ display:flex; align-items:flex-start; overflow:auto; }
    .rowlbls{
      color:var(--muted); font-size:12px; width:34px; margin-right:6px;
      display:grid; grid-template-rows:repeat(7,16px); gap:6px; flex:0 0 auto;
    }
    .heat{
      display:grid; grid-auto-flow:column; grid-auto-columns:16px; gap:6px;
      padding:4px 2px; flex:1 1 auto; min-height:140px;
    }
    .cell{
      width:16px; height:16px; border-radius:3px; background:var(--cell); outline:1px solid var(--cell-edge); cursor:pointer;
    }

    .stats{ color:#fff; display:flex; gap:22px; margin-top:8px; font-size:14px; }
    .stats .k{ font-weight:800; }
    .cta{ margin-top:12px; display:flex; justify-content:flex-end; }

    .todayDone{ background:var(--chip); border:1px solid var(--line); border-radius:12px; padding:8px 12px; display:flex; align-items:center; gap:8px; color:var(--ink); }
    .check{ width:18px; height:18px; border-radius:50%; background:var(--ok); display:inline-grid; place-items:center; color:#0b0f14; font-weight:900; }
    .check:after{ content:'‚úì'; font-size:12px; line-height:1; }

    .modal, .pop{ position:fixed; left:0; top:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; z-index:50; }
    .modal .panel, .pop .panel{
      background:var(--card); border:1px solid var(--line); border-radius:14px;
      padding:16px; min-width:360px; max-width:min(520px, 92vw); color:var(--ink);
      overflow:hidden;
    }
    .rowx{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .field{
      width:100%; background:var(--chip); color:var(--ink); border:1px solid var(--line);
      border-radius:10px; padding:10px 12px; min-width:0;
    }
    .tiny{ color:var(--muted); font-size:12px; }
    .tooltip{ position:fixed; pointer-events:none; background:var(--card); border:1px solid var(--line);
      padding:6px 9px; border-radius:8px; font-size:12px; color:var(--ink); display:none; z-index:100; white-space:pre; }

    .kbd{ background:#232a38; color:#e8eef6; border:1px solid #3a4356; border-radius:6px; padding:2px 6px; font-size:12px; }
    .dark .kbd{ background:#1b2230; }

    .days7{ display:grid; grid-template-columns:repeat(2, 1fr); gap:8px 18px; margin:8px 0 4px; }
    .days7 label{ display:flex; align-items:center; gap:8px; }

    .dd.floating{ position:absolute; background:var(--card); border:1px solid var(--line);
      border-radius:12px; min-width:240px; z-index:60; overflow:hidden; box-shadow:0 6px 28px rgba(0,0,0,.25); }
    .dd.floating .item{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--line); cursor:pointer; color:var(--ink); }
    .dd.floating .item:last-child{ border-bottom:none; }
    .dd.floating .item.delete{ color:var(--danger); }
    .dd.floating svg{ width:16px; height:16px; }
  </style>
</head>
<body>
<div id="root" class="wrap">

  <div class="top">
    <input id="q" class="search" placeholder="Search habits" />
    <button class="btn" id="reorder">Reorder</button>
    <div class="menu" id="createMenu">
      <button class="btn">Create habit ‚ñæ</button>
      <div class="dd">
        <div class="item" data-type="number"><svg viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2"/></svg># Number</div>
        <div class="item" data-type="checkbox"><svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="3" stroke="currentColor" stroke-width="2"/><path d="M8 12l3 3 5-6" stroke="currentColor" stroke-width="2"/></svg>Checkbox</div>
      </div>
    </div>
  </div>

  <div id="list" class="grid"></div>
</div>

<div id="tip" class="tooltip"></div>

<div id="logPop" class="pop">
  <div class="panel">
    <div class="rowx" style="justify-content:space-between">
      <div class="rowx">
        <div id="dot" style="width:10px;height:10px;border-radius:50%;background:#f2c14e"></div>
        <strong id="lpHabit" style="margin-left:6px"></strong>
      </div>
      <button class="btn kbd" id="esc1">esc</button>
    </div>
    <div class="tiny" style="margin-top:12px">Date:</div>
    <div id="lpDate" style="margin:6px 0 10px 0; font-weight:700"></div>
    <div id="lpValWrap">
      <input id="lpVal" class="field" type="number" min="0" step="1" placeholder="minutes"/>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px">
      <div id="lpStreak" class="tiny" style="display:flex;align-items:center;gap:6px">üî• <span>0 days streak</span></div>
      <div class="rowx">
        <button class="btn danger" id="undo" style="display:none">Undo</button>
        <button class="btn success" id="save">Save</button>
      </div>
    </div>
  </div>
</div>

<div id="edit" class="modal">
  <div class="panel">
    <div class="rowx" style="justify-content:space-between">
      <strong>Edit habit</strong>
      <button class="btn kbd" id="esc2">esc</button>
    </div>
    <div style="display:flex; flex-direction:column; gap:10px; margin-top:12px">
      <input id="ehName" class="field" placeholder="Title"/>
      <select id="ehType" class="field">
        <option value="number">Number</option>
        <option value="checkbox">Checkbox</option>
      </select>
      <input id="ehUnit" class="field" placeholder="Unit (minutes, pages, ...)" />
      <input id="ehColor" class="field" type="color" value="#35c27a" />
      <div>
        <div class="tiny" style="margin:8px 0 6px">Calculate streak only on:</div>
        <div class="days7" id="ehDays"></div>
      </div>
      <button class="btn success" id="ehSave">Save changes</button>
    </div>
  </div>
</div>

<div id="embed" class="modal">
  <div class="panel">
    <div class="rowx" style="justify-content:space-between">
      <strong>Embed Habit</strong>
      <button class="btn kbd" id="esc3">esc</button>
    </div>
    <div style="display:flex; flex-direction:column; gap:10px; margin-top:12px">
      <label><input type="checkbox" id="emDark" checked/> Notion dark mode</label>
      <label><input type="checkbox" id="emWrite" checked/> Create entries directly on embed</label>
      <button class="btn" id="emCopy">Copy unique link</button>
      <input id="emOut" class="field" readonly/>
      <div class="tiny">Paste this link into Notion‚Äôs ‚Äú/Embed‚Äù block.</div>
    </div>
  </div>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  if (qs.get('dark')==='1') document.body.classList.add('dark');
  const EMBED_HABIT = qs.get('habitId') || null;

  const API = {
    async list(){ return j(await fetch('/api/habits')); },
    async create(h){ return j(await fetch('/api/habits',{method:'POST', headers:json(), body:JSON.stringify(h)})); },
    async update(h){ return j(await fetch('/api/habits',{method:'PATCH', headers:json(), body:JSON.stringify(h)})); },
    async del(id){ return j(await fetch('/api/habits',{method:'DELETE', headers:json(), body:JSON.stringify({id})})); },
    async heatmap(habitId, mode){ const q = new URLSearchParams(); q.set('habitId',habitId); if (mode==='last365') q.set('last365','1'); else q.set('year',mode); return j(await fetch('/api/heatmap?'+q.toString())); },
    async log(habitId, date, value){ return j(await fetch('/api/log',{method:'POST', headers:json(), body:JSON.stringify({habitId,date,value})})); },
    async reorder(orders){ return j(await fetch('/api/reorder',{method:'POST', headers:json(), body:JSON.stringify({orders})})); },
    async embedLink(habitId, opts){ return j(await fetch('/api/embed',{method:'POST', headers:json(), body:JSON.stringify({habitId, ...opts})})); }
  };
  function json(){ return {'Content-Type':'application/json'}; }
  async function j(r){ if(!r.ok) throw new Error(await r.text()); return await r.json(); }

  const $list = id('list'), $q = id('q'), $tip = id('tip');
  let HABITS = [], REORDER = false;

  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeDropdowns(); ['logPop','edit','embed'].forEach(s=>show(s,false)); }});
  id('esc1').onclick = ()=> show('logPop', false);
  id('esc2').onclick = ()=> show('edit', false);
  id('esc3').onclick = ()=> show('embed', false);

  init();

  function applySearch(){ const v = $q.value.toLowerCase(); for(const card of $list.querySelectorAll('.card')){ const t = card.dataset.name.toLowerCase(); card.style.display = t.includes(v)?'block':'none'; } }

  async function init(){
    menu(id('createMenu'));
    id('reorder').onclick = ()=> toggleReorder();
    $q.oninput = applySearch;
    await load();
  }

  async function load(){
    const data = await API.list();
    HABITS = data.habits || [];
    render();
    if (EMBED_HABIT){ for(const card of $list.querySelectorAll('.card')) if (card.dataset.id !== EMBED_HABIT) card.remove(); document.querySelector('.top').style.display='none'; }
  }

  function toggleReorder(){
    REORDER = !REORDER; id('reorder').textContent = REORDER ? 'Save order' : 'Reorder';
    for (const card of $list.querySelectorAll('.card')){ card.draggable = REORDER; card.style.cursor = REORDER ? 'grab' : 'default'; }
    if (!REORDER){ const orders = Array.from($list.children).map((el,i)=>({ id:el.dataset.id, order:i })); API.reorder(orders).catch(console.error); }
  }

  function render(){
    $list.innerHTML = '';
    for (const h of HABITS){ $list.appendChild(renderCard(h)); }
    applySearch();
  }

  function renderCard(habit){
    const host = div('card');
    const card = div('box'); host.appendChild(card);
    host.dataset.id = habit.id; host.dataset.name = habit.name;

    const hdr = div('hdr');
    const title = div('title'); title.textContent = habit.name.toUpperCase();
    const icons = div('icons');
    const cal = iconBtn(`<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="17" rx="3" stroke="currentColor" stroke-width="2"/><path d="M8 2v4M16 2v4M3 10h18" stroke="currentColor" stroke-width="2"/></svg>`);
    const dots = iconBtn(`<svg viewBox="0 0 24 24" fill="none"><circle cx="5" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="19" cy="12" r="2" fill="currentColor"/></svg>`);
    icons.append(cal, dots);
    hdr.append(title, icons);
    card.appendChild(hdr);

    let mode = 'last365';

    const months = div('months'); card.appendChild(months);

    const heatWrap = div('row');
    const rowlbls = div('rowlbls'); rowlbls.innerHTML = `<span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>`;
    heatWrap.appendChild(rowlbls);
    const heat = div('heat'); heatWrap.appendChild(heat);
    card.appendChild(heatWrap);

    const stats = div('stats'); stats.innerHTML =
      `<div><span class="k">Streak:</span> <span id="s${habit.id}">0 days</span></div>
       <div><span class="k">Average:</span> <span id="a${habit.id}">0</span> ${habit.unit||''}</div>
       <div><span class="k">Total:</span> <span id="t${habit.id}">0</span> ${habit.unit||''}</div>`;
    card.appendChild(stats);

    const cta = div('cta'); const btn = button('Log today ‚Üí'); cta.appendChild(btn); card.appendChild(cta);

    cal.onclick = (e)=> openCalendar(e.currentTarget, card, (m)=>{ mode = m; refresh(); });
    dots.onclick = (e)=> openDots(e.currentTarget, card, habit);

    host.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', habit.id));
    host.addEventListener('dragover', e=> { if(REORDER){ e.preventDefault(); const draggingId = e.dataTransfer.getData('text/plain'); const draggingEl = [...$list.children].find(n=>n.dataset.id===draggingId); if(!draggingEl || draggingEl===host) return; const rect = host.getBoundingClientRect(); const before = (e.clientY - rect.top) < rect.height/2; $list.insertBefore(draggingEl, before?host:host.nextSibling);} });

    refresh();

    async function refresh(){
      const data = await API.heatmap(habit.id, mode==='last365'?'last365':mode);
      const days = data.days || [];

      const aligned = alignToMonday(days);
      const weeks = chunkWeeks(aligned);

      months.innerHTML = ''; months.style.gridTemplateColumns = `repeat(${weeks.length}, 16px)`;
      const moIdx = monthStarts(aligned);
      for (let w=0; w<weeks.length; w++){
        const mName = moIdx.get(w);
        const cell = div('m'); cell.textContent = mName || '';
        months.appendChild(cell);
      }

      heat.innerHTML=''; heat.style.gridTemplateColumns = `repeat(${weeks.length}, 16px)`;
      const pal = buildPalette(data.habit.colorHex || '#35c27a');
      for (const wk of weeks){
        for (let r=0;r<7;r++){
          const d = wk[r];
          const v = Number(d?.value||0);
          const lvl = level(aligned, v);
          const c = div('cell');
          c.style.background = (lvl===0)?'var(--cell)':pal[lvl];
          if (d){
            c.dataset.date = d.date; c.dataset.value = v;
            c.onmouseenter = (evt)=> showTip(evt, d.date, v, habit.unit||'');
            c.onmouseleave = ()=> $tip.style.display='none';
            c.onclick = ()=> openLog(habit, new Date(d.date+'T00:00:00'), v, btn, data.stats.streak, data.stats.continuesToday);
          } else {
            c.style.opacity = 0.25;
          }
          heat.appendChild(c);
        }
      }

      const streakText = (data.stats.streak||0) + ' days' + (data.stats.continuesToday ? ' (today)' : '');
      id(`s${habit.id}`).textContent = streakText;
      id(`a${habit.id}`).textContent = fmt(data.stats.average||0);
      id(`t${habit.id}`).textContent = fmt(data.stats.total||0);

      const todayKey = ymd(todayLocal());
      const today = days.find(x=>x.date===todayKey);
      const tv = Number(today?.value||0);
      if (tv>0){ btn.innerHTML = `Today: ${tv} ${habit.unit||''} <span class="check"></span>`; }
      else { btn.textContent = 'Log today ‚Üí'; }
      btn.onclick = ()=> openLog(habit, todayLocal(), tv, btn, data.stats.streak, data.stats.continuesToday);
    }

    return host;
  }

  function openCalendar(anchor, container, onPick){
    dropdown(anchor, container, [
      {label:'Past 365 days'},
      {label:String(new Date().getFullYear())}
    ], (obj)=> onPick(obj.label==='Past 365 days' ? 'last365' : Number(obj.label)), true);
  }

  function openDots(anchor, container, habit){
    const items = [
      {label:'Edit', svg:`<svg viewBox="0 0 24 24" fill="none"><path d="M4 20h4l10-10-4-4L4 16v4zM14 6l4 4" stroke="currentColor" stroke-width="2"/></svg>`},
      {label:'Embed', svg:`<svg viewBox="0 0 24 24" fill="none"><path d="M9 18l-6-6 6-6M15 6l6 6-6 6" stroke="currentColor" stroke-width="2"/></svg>`},
      {label:'Delete', svg:`<svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6v14m8-14v14M6 6l1-2h10l1 2" stroke="currentColor" stroke-width="2"/></svg>`, delete:true}
    ];
    dropdown(anchor, container, items, async (picked)=>{
      if (picked.label==='Edit') openEdit(habit);
      if (picked.label==='Embed'){
        try {
          const r = await API.embedLink(habit.id, { dark:true, canWrite:true });
          id('emOut').value = r.url;
          await navigator.clipboard.writeText(r.url);
          id('emCopy').textContent = 'Copied link';
        } catch(e){
          console.error(e);
        }
        show('embed', true);
      }
      if (picked.label==='Delete'){
        if (confirm('Delete this habit?')){ await API.del(habit.id); await load(); }
      }
    }, true);
  }

  function openEdit(h){
    id('ehName').value = h.name;
    id('ehType').value = h.type;
    id('ehUnit').value = h.type==='number' ? (h.unit||'') : '';
    id('ehUnit').style.display = (h.type==='number') ? 'block' : 'none';
    id('ehColor').value = h.color_hex || '#35c27a';

    const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const sel = new Set(h.streak_days || days);
    const box = id('ehDays'); box.innerHTML='';
    days.forEach(d=>{
      const lab = document.createElement('label');
      lab.innerHTML = `<input type="checkbox" value="${d}" ${sel.has(d)?'checked':''}/> ${d}`;
      box.appendChild(lab);
    });
    id('ehType').onchange = ()=> {
      const t = id('ehType').value;
      id('ehUnit').style.display = (t==='number') ? 'block' : 'none';
    };

    show('edit', true);

    id('ehSave').onclick = async()=>{
      const streakDays = [...box.querySelectorAll('input[type=checkbox]')].filter(x=>x.checked).map(x=>x.value);
      await API.update({
        id: h.id,
        name: id('ehName').value,
        unit: id('ehType').value==='number' ? id('ehUnit').value : '',
        colorHex: id('ehColor').value,
        streakDays
      });
      show('edit', false); await load();
    };
  }

  function openLog(habit, dateObj, currentValue, btn, streak, continuesToday){
    id('lpHabit').textContent = habit.name;
    id('dot').style.background = habit.color_hex || '#f2c14e';
    id('lpDate').textContent = dateObj.toLocaleDateString(undefined, { weekday:'short', year:'numeric', month:'short', day:'numeric' });

    const wrap = id('lpValWrap');
    const input = id('lpVal');
    const isCheckbox = habit.type === 'checkbox';
    wrap.style.display = isCheckbox ? 'none' : 'block';
    if (!isCheckbox){ input.placeholder = habit.unit || 'units'; input.value = currentValue>0 ? currentValue : ''; }
    id('lpStreak').querySelector('span').textContent = `${streak||0} days streak${continuesToday?' (today)':''}`;

    const $undo = id('undo');
    $undo.style.display = (currentValue>0) ? 'inline-block' : 'none';
    show('logPop', true);

    id('save').onclick = async()=>{
      const val = isCheckbox ? 1 : Number(input.value||0);
      await API.log(habit.id, ymd(dateObj), val);
      show('logPop', false); await load();
    };

    $undo.onclick = async()=>{
      await API.log(habit.id, ymd(dateObj), 0);
      show('logPop', false);
      await load();
    };
  }

  function buildPalette(hex){
    const [h,s,l] = hexToHsl(hex||'#35c27a');
    return {
      1: hslToHex(h, Math.min(1,s), clamp01(l*0.58)),
      2: hslToHex(h, Math.min(1,s), clamp01(l*0.68)),
      3: hslToHex(h, Math.min(1,s), clamp01(l*0.80)),
      4: hslToHex(h, Math.min(1,s), clamp01(l*0.92))
    };
  }
  function level(days, v){
    if (v<=0) return 0;
    const vals = days.map(d=>(d?Number(d.value)||0:0)).filter(x=>x>0).sort((a,b)=>a-b);
    if (vals.length<5) return 1;
    const q = p => vals[Math.floor((vals.length-1)*p)];
    const S=[0,q(0.2),q(0.4),q(0.6),q(0.8)];
    if (v>S[4]) return 4; if (v>S[3]) return 3; if (v>S[2]) return 2; return 1;
  }
  function alignToMonday(days){
    const out = days.slice();
    if (!out.length) return out;
    const first = new Date(out[0].date+'T00:00:00');
    const dow = first.getDay();
    const need = (dow===1)?0 : ((dow===0)?6 : (dow-1));
    return Array(need).fill(null).concat(out);
  }
  function chunkWeeks(days){
    const weeks=[]; let buf=[];
    for (let i=0;i<days.length;i++){
      buf.push(days[i]);
      if (buf.length===7){ weeks.push(buf); buf=[]; }
    }
    if (buf.length){ while(buf.length<7) buf.push(null); weeks.push(buf); }
    return weeks;
  }
  function monthStarts(days){
    const map=new Map();
    const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    for (let i=0;i<days.length;i++){
      const d = days[i];
      if (!d) continue;
      const dt = new Date(d.date+'T00:00:00');
      if (dt.getDate()===1){
        const weekIdx = Math.floor(i/7);
        map.set(weekIdx, months[dt.getMonth()]);
      }
    }
    return map;
  }
  function showTip(evt, date, value, unit){
    const s = `${value||0} ${unit||''}`.trim();
    document.getElementById('tip').textContent = `${s || '0'}\n${new Date(date+'T00:00:00').toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric', year:'numeric' })}`;
    document.getElementById('tip').style.display='block'; document.getElementById('tip').style.left=evt.clientX+12+'px'; document.getElementById('tip').style.top=evt.clientY-12+'px';
  }
  function todayLocal(){ const n=new Date(); return new Date(n.getFullYear(),n.getMonth(),n.getDate()); }
  function ymd(d){ const z=n=>n<10?'0'+n:n; return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
  function fmt(n){ return (Math.round(n*100)/100).toString(); }
  function id(s){ return document.getElementById(s); }
  function div(c){ const n=document.createElement('div'); if(c) n.className=c; return n; }
  function button(t){ const n=document.createElement('button'); n.className='btn'; n.textContent=t; return n; }
  function iconBtn(svg){ const b=document.createElement('button'); b.className='iconbtn'; b.innerHTML=svg; return b; }

  function closeDropdowns(){ document.querySelectorAll('.dd.floating').forEach(n=>n.remove()); }

  function dropdown(anchor, container, items, onPick, withIcons=false){
    closeDropdowns();
    const wrap = document.createElement('div'); wrap.className='dd floating';
    container.appendChild(wrap);

    items.forEach(obj=>{
      const it=document.createElement('div'); it.className='item'+(obj.delete?' delete':'');
      it.innerHTML = withIcons ? `${obj.svg||''} ${obj.label}` : obj.label;
      it.onclick=(e)=>{ e.stopPropagation(); closeDropdowns(); onPick(obj); };
      wrap.appendChild(it);
    });

    const ar = anchor.getBoundingClientRect();
    const cr = container.getBoundingClientRect();
    const width = 240;

    let left = (ar.right - cr.left) - width;
    if (left < 8) left = 8;
    let top = (ar.bottom - cr.top) + 6;

    wrap.style.left = left + 'px';
    wrap.style.top = top + 'px';

    requestAnimationFrame(()=>{
      const wr = wrap.getBoundingClientRect();
      let deltaX = 0, deltaY = 0;
      if (wr.right > cr.right) deltaX = cr.right - wr.right - 8;
      if (wr.left < cr.left) deltaX = cr.left - wr.left + 8;
      if (wr.bottom > cr.bottom) deltaY = -((wr.height) + 12);
      if (wr.top < cr.top) deltaY = (ar.bottom - wr.top) + 6;
      if (deltaX || deltaY){
        wrap.style.left = (left + deltaX) + 'px';
        wrap.style.top = (top + deltaY) + 'px';
      }
    });

    const onDoc=(e)=>{
      if (!wrap.contains(e.target) && e.target !== anchor){
        closeDropdowns();
        document.removeEventListener('click', onDoc);
      }
    };
    setTimeout(()=>document.addEventListener('click', onDoc), 0);
  }

  function menu(el){
    const btn = el.querySelector('button'); const dd = el.querySelector('.dd');
    btn.onclick = ()=> el.classList.toggle('open');
    el.querySelectorAll('.item').forEach(it=> it.onclick = async()=>{
      el.classList.remove('open');
      const type = it.dataset.type;
      const name = prompt('Name the habit'); if(!name) return;
      let unit=''; if (type==='number'){ unit = prompt('Unit (e.g., minutes)') || ''; }
      const color = '#35c27a';
      const streakDays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      try {
        await API.create({ name, type, unit, colorHex: color, streakDays });
        await load();
      } catch (e) {
        alert('Failed to create habit. Open console for details.');
        console.error(e);
      }
    });
  }

  function show(idv, on){ const m=document.getElementById(idv); m.style.display = on ? 'flex' : 'none'; }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function hexToHsl(hex){ const [r,g,b]=hexToRgb(hex).map(x=>x/255); const max=Math.max(r,g,b),min=Math.min(r,g,b); let h,s,l=(max+min)/2; if(max===min){h=s=0;} else { const d=max-min; s=l>0.5? d/(2-max-min): d/(max+min); switch(max){ case r:h=(g-b)/d+(g<b?6:0);break; case g:h=(b-r)/d+2;break; case b:h=(r-g)/d+4;break;} h/=6;} return [h,s,l]; }
  function hexToRgb(hex){ const h=hex.replace('#',''); return [parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16),parseInt(h.slice(4,6),16)]; }
  function hslToHex(h,s,l){ const rgb=hslToRgb(h,s,l).map(x=>Math.round(x*255)); return '#'+rgb.map(x=>x.toString(16).padStart(2,'0')).join(''); }
  function hslToRgb(h,s,l){ let r,g,b; if(s===0){ r=g=b=l; } else { const hue2rgb=(p,q,t)=>{ if(t<0)t+=1; if(t>1)t-=1; if(t<1/6)return p+(q-p)*6*t; if(t<1/2)return q; if(t<2/3)return p+(q-p)*(2/3-t)*6; return p; }; const q=l<0.5? l*(1+s): l+s-l*s; const p=2*l-q; r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3); } return [r,g,b]; }
})();
</script>
</body>
</html>
